name: Telegram Notification
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  issues:
    types: [opened, closed, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Get commit messages
      if: github.event_name == 'push'
      id: get_commits
      run: |
        COMMITS=$(git log --format="%h - %s" ${GITHUB_EVENT_BEFORE}..${GITHUB_SHA})
        COMMITS="${COMMITS//'%'/'%25'}"
        COMMITS="${COMMITS//$'\n'/'%0A'}"
        COMMITS="${COMMITS//$'\r'/'%0D'}"
        echo "commits=${COMMITS}" >> $GITHUB_OUTPUT

    - name: Send Telegram notification with text
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
      run: |
        MESSAGE="üöÄ ${{ github.event_name }} –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ${{ github.repository }}

        üìù ${{ github.event.head_commit.message }}

        ${{ steps.get_commits.outputs.commits }}"
        
        curl -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
        -d chat_id=${TELEGRAM_CHAT_ID} \
        -d message_thread_id=${TELEGRAM_TOPIC_ID} \
        -d text="${MESSAGE}" \
        -d parse_mode=HTML

    - name: Send Telegram notification with GIF
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
      run: |
        curl -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendAnimation \
        -d chat_id=${TELEGRAM_CHAT_ID} \
        -d message_thread_id=${TELEGRAM_TOPIC_ID} \
        -d animation="https://i.giphy.com/cFkiFMDg3iFoI.webp" \
        -d caption="üîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://github.com/${{ github.repository }}/commit/${{github.sha}}"
